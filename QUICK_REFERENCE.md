# Quick Reference Guide - Alembic Migrations

## Essential Commands

### Check Status
```bash
alembic current              # Show current migration version
alembic history             # Show all migrations
alembic history --verbose   # Show detailed history
```

### Apply Migrations
```bash
alembic upgrade head        # Apply all pending migrations
alembic upgrade +1          # Apply next migration only
alembic upgrade <revision>  # Apply up to specific migration
```

### Rollback Migrations
```bash
alembic downgrade -1        # Rollback last migration
alembic downgrade <revision> # Rollback to specific migration
alembic downgrade base      # Rollback all migrations
```

### Create New Migrations
```bash
# Manual migration (you write the code)
alembic revision -m "add user role column"

# Autogenerated migration (Alembic detects model changes)
alembic revision --autogenerate -m "add user role column"
```

### Docker Commands
```bash
# Start services (runs migrations automatically)
docker-compose up -d

# View logs
docker-compose logs -f web

# Stop services
docker-compose down

# Rebuild and start
docker-compose up -d --build
```

### Testing
```bash
# Run all migration tests
pytest tests/test_migrations.py -v

# Run specific test
pytest tests/test_migrations.py::TestMigrations::test_upgrade_downgrade_cycle -v

# Validate setup
./validate_setup.sh
```

## Common Workflows

### Adding a New Column
1. Edit model in `app/models.py`
2. Generate migration: `alembic revision --autogenerate -m "add column"`
3. Review generated file in `migrations/versions/`
4. Test locally: `alembic upgrade head`
5. Test rollback: `alembic downgrade -1`
6. Commit migration file

### Creating an Index
1. Create migration: `alembic revision -m "add index on users email"`
2. Edit migration file:
   ```python
   def upgrade():
       op.create_index('ix_users_email', 'users', ['email'])
   
   def downgrade():
       op.drop_index('ix_users_email', table_name='users')
   ```
3. Test and commit

### First Time Setup
```bash
# 1. Clone repo
git clone https://github.com/mexadigital/mexa-core.git
cd mexa-core

# 2. Setup environment
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# 3. Configure database
cp .env.example .env
# Edit .env with your database credentials

# 4. Create database
createdb mexa_db

# 5. Run migrations
alembic upgrade head

# 6. Start app
uvicorn app.main:app --reload
```

## Troubleshooting

### "alembic_version table doesn't exist"
```bash
alembic stamp head
```

### Migration fails with error
```bash
# Rollback and fix
alembic downgrade -1
# Fix the migration file
alembic upgrade head
```

### Out of sync with remote
```bash
alembic current  # Check your version
alembic history  # See what's available
```

## Key Files

- `alembic.ini` - Main configuration
- `migrations/env.py` - Environment setup
- `migrations/versions/*.py` - Migration files
- `MIGRATIONS.md` - Full guide
- `DEVELOPMENT.md` - Developer guide

## Best Practices

✅ **DO:**
- Test migrations locally before committing
- Include both upgrade() and downgrade()
- Review autogenerated migrations
- Create database backups before production migrations
- Keep migrations small and focused

❌ **DON'T:**
- Edit already-applied migrations
- Delete migration files
- Skip migrations when deploying
- Make migrations with breaking changes without planning

## Need Help?

1. Check [MIGRATIONS.md](MIGRATIONS.md) for detailed guide
2. Check [DEVELOPMENT.md](DEVELOPMENT.md) for setup help
3. Run `./validate_setup.sh` to verify your setup
4. Review [IMPLEMENTATION_SUMMARY.md](IMPLEMENTATION_SUMMARY.md)

## Emergency Rollback

If something goes wrong in production:

```bash
# Quick rollback
alembic downgrade -1

# Or restore from backup
pg_dump -h $DB_HOST -U $DB_USER -d $DB_NAME < backup.sql
```

Always have a backup before running migrations in production!
